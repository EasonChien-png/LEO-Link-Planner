<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LEO é€£ç·šé ä¼°è§€æ¸¬ v5.6ï½œRealistic Link Margin Planner</title>
<style>
  :root { --bg:#0b1020; --card:#111627; --ink:#e5e7eb; --muted:#94a3b8; --accent:#60a5fa; --ok:#34d399; --bad:#f87171; --warn:#f59e0b; }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--ink); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial}
  header{padding:20px 24px; border-bottom:1px solid #1f2937}
  h1{margin:0; font-size:22px; letter-spacing:.5px}
  main{display:grid; grid-template-columns: 1fr; gap:18px; padding:12px}
  @media(min-width:1000px){ main{grid-template-columns: 480px 1fr; padding:18px} }
  .panel{background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:14px; box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .panel h2{font-size:16px; margin:4px 0 10px 0; color:#cbd5e1}
  label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
  input,select{width:100%; padding:12px 14px; background:#0f172a;border:1.5px solid #3b82f6; border-radius:12px; color:var(--ink); outline:none}
  input::placeholder{color:#cbd5e1; opacity:.9}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media(max-width:720px){ .row{grid-template-columns:1fr} }
  .btn{background:#1e293b; color:#fff; border:1px solid #334155; border-radius:12px; padding:12px 14px; cursor:pointer}
  .btn:hover{background:#0f172a}
  .legend{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 0}
  .pill{padding:4px 10px; border-radius:999px; border:1px solid #334155; background:#0f172a; font-size:12px; white-space:nowrap}
  .status{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .stat{padding:6px 10px; border-radius:10px; border:1px solid #334155; background:#0f172a; font-size:12px; display:inline-flex; align-items:center; gap:6px}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
  canvas{width:100%; height:560px; background:#0b1020; border-radius:12px; border:1px solid #1f2937}
  footer{padding:10px 18px; color:#94a3b8}
  .muted{color:#94a3b8; font-size:12px}
  .note{margin-top:8px; font-size:12px; color:#a5b4fc}
  .toolbar{display:flex; gap:8px; align-items:center; margin-top:10px; flex-wrap:wrap}
  .switch{display:flex; align-items:center; gap:6px}
  details{margin-top:10px}
  summary{cursor:pointer; color:#93c5fd}
  .kv{display:grid; grid-template-columns:160px 1fr; gap:6px; margin-top:6px; font-size:12px; color:#cbd5e1}
  .kv div{padding:4px 8px; background:#0f172a; border:1px solid #334155; border-radius:8px}
  .stack{display:flex; flex-direction:column; gap:8px}
  .inlineBtns{display:flex; gap:8px; flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1 id="pageTitle">LEO é€£ç·šé ä¼°è§€æ¸¬ v5.6ï½œLink Margin (Eb/N0) å¯¦å‹™ç‰ˆ</h1>
  <div class="muted">è¡Œå‹•ç‰ˆä¿®æ­£ï¼šåŸå¸‚è¼¸å…¥æ¬„ä½æ”¹ç‚ºã€Œç¨ç«‹ä¸€è¡Œã€å…¨å¯¬ã€é«˜å°æ¯”é‚Šæ¡†èˆ‡æç¤ºå­—ã€ã€‚è·é›¢æ„ˆé  â†’ dB æ„ˆå°ï¼›åŠŸç‡æ„ˆå¤§ â†’ dB ä¸Šå‡ã€‚</div>
</header>

<main>
  <section class="panel" id="controls">
    <h2>åƒæ•¸è¨­å®š</h2>
    <div class="status" id="netStatus"></div>
    <div class="status" id="linkStatus"></div>

    <label>å°ˆæ¡ˆåç¨±ï¼ˆæª”åå‰ç¶´ / ä¹Ÿæœƒé¡¯ç¤ºæ–¼é é¢æ¨™é¡Œï¼‰</label>
    <input id="projName" type="text" value="LEO_LinkTest" placeholder="ä¾‹å¦‚ï¼šEason_LEO_LinkTest"/>

    <label>æ¨¡å¼ Mode</label>
    <select id="mode">
      <option value="weather" selected>å¤©æ°£æƒ…å¢ƒæ¯”è¼ƒï¼ˆè‡ªå®š + æ™´å¤©/é™°å¤©/å¤§é›¨ï¼‰</option>
      <option value="bitrate">Ã—é€Ÿç‡æ¯”è¼ƒï¼ˆè‡ªå®šå¤©æ°£ä¸‹æ¯” 3 æª”è³‡æ–™ç‡ï¼‰</option>
    </select>

    <div class="row">
      <div>
        <label>æœ€å¤§æ–œè·ä¸Šé™ (km) â‰¤ 2000ï¼ˆèµ·é»å›ºå®š 600ï¼‰</label>
        <input id="maxRange" type="number" value="2000" min="600" max="2000" step="10"/>
      </div>
      <div>
        <label>æƒæé»æ•¸ï¼ˆè§£æåº¦ï¼‰</label>
        <input id="npts" type="number" value="300" min="50" max="1500" step="10"/>
      </div>
    </div>

    <div class="row">
      <div>
        <label>TX Power ç™¼å°„åŠŸç‡ (W)</label>
        <input id="txPower" type="number" value="3.0" min="0.05" max="20" step="0.1"/>
      </div>
      <div>
        <label>æ¥æ”¶æ©Ÿé›œè¨Šåœ– NF (dB)</label>
        <input id="nf" type="number" value="1.0" min="0.3" max="5" step="0.1"/>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Tx Antenna Gain (dBi)</label>
        <input id="gtx" type="number" value="8.0" min="0" max="25" step="0.5"/>
      </div>
      <div>
        <label>Rx Antenna Gain (dBi)</label>
        <input id="grx" type="number" value="18.0" min="0" max="30" step="0.5"/>
      </div>
    </div>

    <div id="weatherBox">
      <div class="row">
        <div>
          <label>å¤©æ°£è¡°æ¸› Weather Attn (dB)</label>
          <input id="wAttn" type="number" value="0.5" min="0" max="15" step="0.1"/>
        </div>
        <div>
          <label>å¤©ç©ºæº«åº¦ Sky Temp (K)</label>
          <input id="skyT" type="number" value="260" min="200" max="700" step="10"/>
        </div>
      </div>
      <div class="note">åƒè€ƒï¼šæ™´å¤© 0â€“1 dB / 260â€“300 Kï¼›é™°å¤© 1â€“2 dB / 300â€“350 Kï¼›å¤§é›¨ 3â€“6 dB / 400â€“600 K</div>

      <div class="stack" style="margin-top:6px">
        <label>è«‹è¼¸å…¥åŸå¸‚åç¨±ï¼ˆå¯ä¸­æ–‡æˆ–è‹±æ–‡ï¼Œå¦‚ï¼šå°åŒ— æˆ– Taipeiï¼‰</label>
        <input id="city" type="text" placeholder="ä¾‹ï¼šTaipeiã€Hsinchuã€Tokyoã€Los Angeles"/>
        <div class="inlineBtns">
          <button class="btn" id="fetchCity">æŸ¥åŸå¸‚å¤©æ°£</button>
          <button class="btn" id="useHere">ä½¿ç”¨æˆ‘çš„ä½ç½®</button>
        </div>
      </div>
      <div id="wxInfo" class="muted" style="margin-top:8px">â€”</div>
    </div>

    <div id="bitrateBox" style="display:none">
      <label>Bit Rates (bps) â€” ç”¨é€—è™Ÿåˆ†éš”ä¸‰æª”</label>
      <input id="rates" type="text" value="9600, 38400, 192000"/>
    </div>

    <div id="singleRateBox">
      <label>å–®ä¸€ Bit Rateï¼ˆåƒ…å¤©æ°£æ¨¡å¼ä½¿ç”¨ï¼‰</label>
      <input id="singleRate" type="number" value="9600" min="1200" max="1000000" step="600"/>
    </div>

    <div class="toolbar">
      <button class="btn" id="run">ç¹ªè£½</button>
      <label class="switch">
        <input id="autoupdate" type="checkbox" checked/>
        <span class="muted">å³æ™‚æ›´æ–°</span>
      </label>
      <button class="btn" id="reset">é‡è¨­åƒæ•¸</button>
      <button class="btn" id="dlCsv">åŒ¯å‡º CSV</button>
      <button class="btn" id="dlPng">ä¸‹è¼‰ PNG</button>
      <span id="status" class="muted">â€”</span>
    </div>

    <div class="muted" style="margin-top:6px">
      åˆ†äº«é€£çµï¼ˆè‡ªå‹•æ›´æ–°ï¼‰ï¼š<span id="shareUrl" style="word-break:break-all;color:#93c5fd"></span>
    </div>

    <details>
      <summary>ğŸ” ç‰©ç† sanity æª¢æŸ¥ï¼ˆè·é›¢èˆ‡åŠŸç‡æ–¹å‘ï¼‰</summary>
      <div class="kv" id="sanity"></div>
    </details>
  </section>

  <section class="panel">
    <h2 id="chartTitle">å¤©æ°£æƒ…å¢ƒæ¯”è¼ƒ</h2>
    <div class="legend" id="legend"></div>
    <canvas id="plot" width="1200" height="560"></canvas>
    <div class="muted" style="margin-top:8px">è™›ç·šç‚º 0 dBï¼ˆè‡¨ç•Œé–€æª»ï¼‰ã€‚ç´…è‰²åŠé€æ˜å€ï¼šè¶…å‡ºæ­¤è·é›¢å¾Œæœ€å°‘ä¸€æ¢æ›²ç·šç„¡æ³•é€šè¨Šã€‚</div>
  </section>
</main>

<footer class="muted">
  å›ºå®šå€¼ï¼šé »ç‡ 437.5 MHzï¼ˆUHFï¼‰ã€Tx ç·šæ 0.5 dBã€å…¶ä»–æè€— 2 dBã€éœ€æ±‚é–€æª» Req Eb/N0 = 9.6 dBã€‚
</footer>

<script>
// ---- å¸¸æ•¸èˆ‡å·¥å…· ----
const K = 1.380649e-23;
const F_MHZ = 437.5;
const TX_LINE_dB = 0.5;
const MISC_BASE_dB = 2.0;
const REQ_EBN0_dB = 9.6;
const COLORS = ["#60a5fa","#f59e0b","#22c55e","#e879f9","#f87171","#34d399"];
const linspace = (a,b,n)=>Array.from({length:n},(_,i)=>a+(b-a)*i/(n-1));
const dB = (x)=>10*Math.log10(x);
// æ¨™æº– FSPLï¼ˆMHz, kmï¼‰
const fspl_dB = (f_mhz, d_km)=> 32.44 + 20*Math.log10(f_mhz) + 20*Math.log10(d_km);
const noiseTempFromNF = (nf_dB, Tref=290)=> Tref*(Math.pow(10,nf_dB/10)-1);
const systemTempK = (nf_dB, skyK, Tmisc=0, Tref=290)=> skyK + noiseTempFromNF(nf_dB,Tref) + Tmisc;
const gOverT_dBperK = (g_dBi, TsysK)=> g_dBi - 10*Math.log10(TsysK);

function val(id){ const el=document.getElementById(id); return el.type==='number'? +el.value : el.value }
function setVal(id, v){ const el=document.getElementById(id); el.value = v }
function sanitizeName(s){
  return (s||'').trim().replace(/[\s\/\\:*?"<>|]+/g,'_').replace(/_+/g,'_').replace(/^_+|_+$/g,'');
}

function updateShareUrl(){
  const params = new URLSearchParams();
  ['projName','mode','maxRange','npts','txPower','nf','gtx','grx','wAttn','skyT','rates','singleRate','autoupdate'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    if(el.type==='checkbox'){ params.set(id, el.checked? '1':'0'); }
    else { params.set(id, el.value); }
  });
  const url = location.origin + location.pathname + '?' + params.toString();
  document.getElementById('shareUrl').textContent = url;
  document.getElementById('pageTitle').textContent = `LEO é€£ç·šé ä¼°è§€æ¸¬ v5.6ï½œ${sanitizeName(val('projName')) || 'Link Margin (Eb/N0) å¯¦å‹™ç‰ˆ'}`;
  document.title = `LEO v5.6ï½œ${sanitizeName(val('projName')) || 'LEO Link Planner'}`;
  history.replaceState(null, '', url);
}
function readParams(){
  const q = new URLSearchParams(location.search);
  const get = (k, d=null)=> q.has(k)? q.get(k): d;
  ['projName','mode','maxRange','npts','txPower','nf','gtx','grx','wAttn','skyT','rates','singleRate'].forEach(k=>{
    const v=get(k); if(v!==null) setVal(k, v);
  });
  const a = get('autoupdate'); if(a!==null) document.getElementById('autoupdate').checked = (a==='1');
}

// ---- å¤©æ°£ï¼ˆOpenâ€‘Meteoï¼‰ ----
async function geocodeCity(name){
  name = (name||'').trim().replace(/\s+/g,' ');
  const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=zh-TW`;
  const r = await fetch(url); if(!r.ok) throw new Error('geocode failed');
  const j = await r.json();
  if(!j.results || !j.results.length) throw new Error('æ‰¾ä¸åˆ°åŸå¸‚');
  const g = j.results[0];
  return {lat:g.latitude, lon:g.longitude, label:`${g.name}${g.admin1? ' Â· '+g.admin1:''} ${g.country_code||''}`};
}
async function fetchWeather(lat, lon){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation,cloud_cover&timezone=auto`;
  const r = await fetch(url); if(!r.ok) throw new Error('weather failed');
  const j = await r.json();
  return j.current;
}
function mapWeatherToParams(wx){
  const cc = wx.cloud_cover ?? 0;        // %
  const pr = wx.precipitation ?? 0;      // mm/h
  const attn = Math.min(0.2 + 0.05*pr + (cc>80?0.2:0.0), 6.0); // dBï¼ˆUHF é›¨è¡°å¾ˆå°ï¼Œä¿‚æ•¸å¯èª¿å°ï¼‰
  const sky = Math.min(240 + 0.8*cc + (pr>5?80:0) , 600);      // K
  return {attn, sky, cc, pr, temp: wx.temperature_2m};
}

// ---- ç¹ªåœ– ----
function plotCurves(canvas, series, title, criticalMin=null){
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  const l=70, r=20, t=46, b=56;
  let xmin=Infinity, xmax=-Infinity, ymin=Infinity, ymax=-Infinity;
  series.forEach(s=>s.xy.forEach(([x,y])=>{ xmin=Math.min(xmin,x); xmax=Math.max(xmax,x); ymin=Math.min(ymin,y); ymax=Math.max(ymax,y) }));
  ymin = Math.min(ymin, -5); ymax = Math.max(ymax, 30);

  // grid
  ctx.strokeStyle="#243044"; ctx.lineWidth=1;
  for(let i=0;i<=6;i++){ const yy = t + (H-t-b)*i/6; ctx.beginPath(); ctx.moveTo(l,yy); ctx.lineTo(W-r,yy); ctx.stroke(); }
  for(let i=0;i<=8;i++){ const xx = l + (W-l-r)*i/8; ctx.beginPath(); ctx.moveTo(xx,t); ctx.lineTo(xx,H-b); ctx.stroke(); }

  // axes
  ctx.strokeStyle="#48566e"; ctx.lineWidth=1.5; ctx.strokeRect(l,t,W-l-r,H-t-b);

  // 0 dB line
  const y0 = H-b - (0 - ymin)/(ymax-ymin)*(H-t-b);
  ctx.setLineDash([6,6]); ctx.strokeStyle="#7c8aa5"; ctx.beginPath(); ctx.moveTo(l,y0); ctx.lineTo(W-r,y0); ctx.stroke(); ctx.setLineDash([]);

  // labels
  ctx.fillStyle="#cbd5e1"; ctx.font="13px system-ui"; ctx.fillText("Slant Range [km]", l+(W-l-r)/2-60, H-16);
  ctx.save(); ctx.translate(18, t+(H-t-b)/2+50); ctx.rotate(-Math.PI/2); ctx.fillText("Link Margin (Eb/N0) [dB]  â†‘ è¼ƒå¤§", 0,0); ctx.restore();
  ctx.font="16px system-ui"; ctx.fillText(title, l, 26);

  // y-ticksï¼ˆä¸Šå¤§ä¸‹å°ï¼‰
  ctx.fillStyle="#94a3b8"; ctx.font="12px system-ui";
  for(let i=0;i<=6;i++){
    const val = (ymax - (ymax-ymin)*i/6).toFixed(0);
    const yy = t + (H-t-b)*i/6;
    ctx.fillText(val, 36, yy+4);
  }
  // x-ticks
  for(let i=0;i<=8;i++){
    const val = (xmin + (xmax-xmin)*i/8).toFixed(0);
    const xx = l + (W-l-r)*i/8;
    ctx.fillText(val, xx-12, H-22);
  }

  // shaded no-comm region
  if(criticalMin!==null){
    const xx = l + (criticalMin - xmin)/(xmax-xmin)*(W-l-r);
    ctx.fillStyle="rgba(248,113,113,0.12)";
    ctx.fillRect(xx, t, (W-r)-xx, (H-t-b));
  }

  // series curves
  series.forEach((s,si)=>{
    const color = s.color || COLORS[si%COLORS.length];
    ctx.strokeStyle = color; ctx.lineWidth=2; ctx.beginPath();
    s.xy.forEach(([x,y],i)=>{
      const xx = l + (x - xmin)/(xmax-xmin)*(W-l-r);
      const yy = H-b - (y - ymin)/(ymax-ymin)*(H-t-b);
      if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy);
    }); ctx.stroke();

    // end labels
    const [xe, ye] = s.xy[s.xy.length-1];
    const xxe = l + (xe - xmin)/(xmax-xmin)*(W-l-r);
    const yye = H-b - (ye - ymin)/(ymax-ymin)*(H-t-b);
    ctx.fillStyle=color; ctx.font="12px system-ui"; ctx.fillText("  "+s.displayLabel, xxe+6, yye+4);

    // vertical line at individual critical distance
    if(s.crit!==null){
      const v = l + (s.crit - xmin)/(xmax-xmin)*(W-l-r);
      ctx.setLineDash([4,8]); ctx.strokeStyle=color; ctx.beginPath(); ctx.moveTo(v,t); ctx.lineTo(v,H-b); ctx.stroke(); ctx.setLineDash([]);
      ctx.fillStyle=color; ctx.font="11px system-ui"; ctx.fillText(`0 dB@${s.crit.toFixed(0)}km`, v+4, t+14);
    }
  });
}

// ç·šæ€§å…§æ’æ‰¾è‡¨ç•Œè·é›¢
function critDist(xy){
  for(let i=1;i<xy.length;i++){
    const [x1,y1]=xy[i-1], [x2,y2]=xy[i];
    if((y1>=0 && y2<=0) || (y1<=0 && y2>=0)){
      const t=(0-y1)/(y2-y1); return x1 + t*(x2-x1);
    }
  }
  return null;
}

// ä¸»è¨ˆç®— + ç‹€æ…‹ + sanity
function computeAndDraw(){
  const now = new Date().toLocaleTimeString();
  document.getElementById('status').textContent = `å·²æ›´æ–° ${now}`;

  const mode = document.getElementById('mode').value;
  const maxRange = Math.min(2000, Math.max(600, +val('maxRange')||2000));
  const npts = Math.max(50, Math.min(1500, parseInt(val('npts'))||300));
  const txP = +val('txPower') || 3.0;
  const nf = +val('nf') || 1.0;
  const gtx = +val('gtx') || 8.0;
  const grx = +val('grx') || 18.0;
  const wAttn = +val('wAttn') || 0.5;
  const skyT = +val('skyT') || 260.0;
  const rates = (val('rates')||"9600,38400,192000").split(',').map(s=>+s.trim()).filter(x=>x>0);
  const singleRate = +val('singleRate') || 9600;

  const dKm = linspace(600, maxRange, npts);
  const Lfs = dKm.map(km=> fspl_dB(F_MHZ, km)); // dB
  const EIRP_dBW = dB(txP) + gtx - TX_LINE_dB;

  function cn0_common(attn_db, sky_k){
    const Tsys = systemTempK(nf, sky_k, 0.0, 290.0);
    const GT = gOverT_dBperK(grx, Tsys);
    return Lfs.map(L => EIRP_dBW + GT - (L + MISC_BASE_dB + attn_db) - 10*Math.log10(K)); // dB-Hz
  }

  const legend = document.getElementById('legend'); legend.innerHTML = "";
  const linkStatus = document.getElementById('linkStatus'); linkStatus.innerHTML = "";
  const series = [];
  let critMin = null;

  if(mode==="weather"){
    document.getElementById('chartTitle').textContent = "å¤©æ°£æƒ…å¢ƒæ¯”è¼ƒ";
    const presets = [
      {displayLabel:"è‡ªå®šç¾© Custom", csvLabel:"Custom", attn:wAttn, sky:skyT, color:COLORS[0]},
      {displayLabel:"æ™´å¤© Clear",    csvLabel:"Clear",  attn:0.5, sky:260, color:COLORS[1]},
      {displayLabel:"é™°å¤© Overcast", csvLabel:"Overcast", attn:1.5, sky:330, color:COLORS[2]},
      {displayLabel:"å¤§é›¨ HeavyRain",csvLabel:"HeavyRain", attn:5.0, sky:480, color:COLORS[3]},
    ];
    presets.forEach((p)=>{
      const CNo = cn0_common(p.attn, p.sky);
      const EbN0 = CNo.map(v => v - 10*Math.log10(singleRate));
      const margin = EbN0.map(v => v - REQ_EBN0_dB);
      const xy = dKm.map((x,i)=>[x, margin[i]]);
      const d0 = critDist(xy);
      if(d0!==null){ critMin = (critMin===null)? d0 : Math.min(critMin, d0); }
      series.push({displayLabel:p.displayLabel, csvLabel:p.csvLabel, xy, color:p.color, crit:d0});
      const tag = document.createElement('div'); tag.className='pill';
      tag.textContent = `${p.displayLabel} Â· Attn ${p.attn} dB Â· Sky ${p.sky} K Â· ${d0?('è‡¨ç•Œ '+d0.toFixed(0)+' km'):'è‡¨ç•Œ > '+maxRange+' km'}`;
      legend.appendChild(tag);
    });
  }else{
    document.getElementById('chartTitle').textContent = "Ã—é€Ÿç‡æ¯”è¼ƒ";
    const CNo = cn0_common(wAttn, skyT);
    rates.slice(0,3).forEach((R, idx)=>{
      const EbN0 = CNo.map(v => v - 10*Math.log10(R));
      const margin = EbN0.map(v => v - REQ_EBN0_dB);
      const xy = dKm.map((x,i)=>[x, margin[i]]);
      const d0 = critDist(xy);
      if(d0!==null){ critMin = (critMin===null)? d0 : Math.min(critMin, d0); }
      const label = `${R.toLocaleString()} bps`;
      series.push({displayLabel:label, csvLabel:label.replace(/\s/g,'') , xy, color:COLORS[idx%COLORS.length], crit:d0});
      const tag = document.createElement('div'); tag.className='pill';
      tag.textContent = `${label} Â· ${d0?('è‡¨ç•Œ '+d0.toFixed(0)+' km'):'è‡¨ç•Œ > '+maxRange+' km'}`;
      legend.appendChild(tag);
    });
    const env = document.createElement('div'); env.className='pill';
    env.textContent = `Weather Attn ${wAttn} dB Â· Sky ${skyT} K`; legend.appendChild(env);
  }

  // ç•«åœ–
  plotCurves(document.getElementById('plot'), series, (mode==="weather"?"å¤©æ°£æƒ…å¢ƒæ¯”è¼ƒ":"Ã—é€Ÿç‡æ¯”è¼ƒ")+"ï¼šEb/N0 é¤˜è£• vs è·é›¢", critMin);
  window._lastSeries = series;

  // å´é‚Šé€šè¨Šç‹€æ…‹
  const worstMargin = series.reduce((acc, s)=> Math.min(acc, s.xy[s.xy.length-1][1]), +Infinity);
  const box = document.createElement('div'); box.className='stat';
  if(worstMargin>0){
    box.innerHTML = `<span class="ok">ğŸŸ¢</span> ç›®å‰æœ€é è·é›¢ä»å¯ç©©å®šé€šè¨Šï¼ˆMargin = ${worstMargin.toFixed(1)} dBï¼‰`;
  }else{
    box.innerHTML = `<span class="bad">ğŸ”´</span> è¶…éæŸè·é›¢å¾Œç„¡æ³•é€šè¨Šï¼ˆè«‹åƒè€ƒåœ–ä¸Šç´…è‰²å€åŸŸèˆ‡å‚ç›´ç·šï¼‰`;
  }
  linkStatus.appendChild(box);

  // ---- Sanity Panel ----
  const sanity = document.getElementById('sanity');
  const s0 = series[0];
  if(s0){
    const m600 = s0.xy[0][1];
    const mMax = s0.xy[s0.xy.length-1][1];
    const EIRP_now = dB(+val('txPower')) + (+val('gtx')) - TX_LINE_dB;
    const EIRP_2x = dB(+val('txPower')*2) + (+val('gtx')) - TX_LINE_dB;
    const deltaP = EIRP_2x - EIRP_now; // â‰ˆ 3 dB
    sanity.innerHTML = `
      <div>FSPL(600km) / FSPL(${maxRange}km)</div><div>${fspl_dB(F_MHZ, 600).toFixed(2)} dB â†’ ${fspl_dB(F_MHZ, maxRange).toFixed(2)} dB</div>
      <div>Margin@600kmï¼ˆä»£è¡¨æ›²ç·šï¼‰</div><div>${m600.toFixed(2)} dBï¼ˆæ‡‰ â‰¥ æœ«ç«¯ï¼‰</div>
      <div>Margin@${maxRange}kmï¼ˆä»£è¡¨æ›²ç·šï¼‰</div><div>${mMax.toFixed(2)} dBï¼ˆæ‡‰ â‰¤ èµ·é»ï¼‰</div>
      <div>åŠŸç‡ç¿»å€ï¼ˆPâ†’2Pï¼‰ç†è«–å½±éŸ¿</div><div>+${deltaP.toFixed(2)} dBï¼ˆæ›²ç·šæ‡‰å¾€æ­£å‘ä½ç§»ï¼‰</div>
    `;
  }

  updateShareUrl();
}

// åŒ¯å‡ºï¼ˆCSV/PNGï¼‰
function download(filename, content, mime){
  const blob = new Blob([content], {type: mime});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}
function toCSV(series){
  const distances = series[0]?.xy.map(p=>p[0].toFixed(2)) || [];
  const header = ['distance_km', ...series.map(s=>s.csvLabel.replace(/,/g,' '))];
  const rows = [header.join(',')];
  for(let i=0;i<distances.length;i++){
    const cols = [distances[i], ...series.map(s=> s.xy[i][1].toFixed(3))];
    rows.push(cols.join(','));
  }
  return rows.join('\n');
}
function timestamp(){
  const d = new Date();
  const pad = n=> String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}`;
}
function filenamePrefix(){
  const p = sanitizeName(val('projName'));
  return p ? p : 'LEO_Link';
}
document.getElementById('dlCsv').addEventListener('click', ()=>{
  const series = window._lastSeries || [];
  const mode = document.getElementById('mode').value;
  const name = `${filenamePrefix()}_${mode==='weather' ? 'weather' : 'bitrate'}_${timestamp()}.csv`;
  const csv = toCSV(series);
  download(name, '\ufeff'+csv, 'text/csv;charset=utf-8');
});
document.getElementById('dlPng').addEventListener('click', ()=>{
  const canvas = document.getElementById('plot');
  const url = canvas.toDataURL('image/png');
  const mode = document.getElementById('mode').value;
  const name = `${filenamePrefix()}_${mode==='weather' ? 'weather' : 'bitrate'}_${timestamp()}.png`;
  const a = document.createElement('a');
  a.href = url;
  a.download = name;
  a.click();
});

// è‡ªå‹•æ›´æ–°èˆ‡é‡è¨­
function bindAutoUpdate(){
  const ids = ["projName","mode","maxRange","npts","txPower","nf","gtx","grx","wAttn","skyT","rates","singleRate","autoupdate"];
  const handler = ()=>{ if(document.getElementById('autoupdate').checked){ computeAndDraw(); } updateShareUrl(); };
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', handler);
    el.addEventListener('change', handler);
  });
}
document.getElementById('reset').addEventListener('click', ()=>{
  setVal('projName','LEO_LinkTest');
  setVal('mode','weather'); setVal('maxRange',2000); setVal('npts',300);
  setVal('txPower',3.0); setVal('nf',1.0); setVal('gtx',8.0); setVal('grx',18.0);
  setVal('wAttn',0.5); setVal('skyT',260);
  setVal('rates','9600,38400,192000'); setVal('singleRate',9600);
  document.getElementById('autoupdate').checked = true;
  computeAndDraw();
  updateShareUrl();
});

document.getElementById('mode').addEventListener('change',(e)=>{
  const mode=e.target.value;
  document.getElementById('bitrateBox').style.display = (mode==='bitrate')?'block':'none';
  document.getElementById('singleRateBox').style.display = (mode==='weather')?'block':'none';
});
document.getElementById('run').addEventListener('click', ()=>{ computeAndDraw(); updateShareUrl(); });

// ç¶²è·¯ç‹€æ…‹
function renderNetStatus(){
  const wrap = document.getElementById('netStatus'); wrap.innerHTML="";
  const box = document.createElement('div'); box.className='stat';
  if(navigator.onLine){
    box.innerHTML = `<span class="ok">ğŸŒ</span> å·²é€£ç·šç¶²éš›ç¶²è·¯ï¼ˆè‡ªå‹•å¤©æ°£å¯ç”¨ï¼‰`;
  }else{
    box.innerHTML = `<span class="warn">âš ï¸</span> é›¢ç·šç‹€æ…‹ï¼šç„¡æ³•æ›´æ–°å¤©æ°£è³‡æ–™`;
  }
  wrap.appendChild(box);
}
window.addEventListener('online', renderNetStatus);
window.addEventListener('offline', renderNetStatus);

// ---- äº‹ä»¶ï¼šæŸ¥åŸå¸‚å¤©æ°£ ----
document.getElementById('fetchCity').addEventListener('click', async ()=>{
  const cityRaw = document.getElementById('city').value;
  const info = document.getElementById('wxInfo');
  if(!cityRaw || !cityRaw.trim()){ info.textContent='è«‹è¼¸å…¥åŸå¸‚åç¨±'; return; }
  if(!navigator.onLine){ info.textContent='ç›®å‰é›¢ç·šï¼Œç„¡æ³•æŸ¥è©¢å¤©æ°£'; return; }
  try{
    info.textContent='æŸ¥è©¢åŸå¸‚åº§æ¨™â€¦';
    const g = await geocodeCity(cityRaw);
    info.textContent=`${g.label}ï¼šå–å¾—å³æ™‚å¤©æ°£â€¦`;
    const wx = await fetchWeather(g.lat, g.lon);
    const m = mapWeatherToParams(wx);
    setVal('wAttn', m.attn.toFixed(2));
    setVal('skyT', Math.round(m.sky));
    info.textContent = `${g.label} â†’ é™æ°´ ${m.pr} mm/hï¼Œé›²é‡ ${m.cc}%ï¼Œåœ°é¢æº«åº¦ ${m.temp}Â°C â†’ å»ºè­° Attn ${m.attn.toFixed(2)} dB / Sky ${Math.round(m.sky)} K`;
    computeAndDraw();
  }catch(err){
    info.textContent='æŸ¥è©¢å¤±æ•—ï¼š'+(err.message||err);
  }
});

// ---- äº‹ä»¶ï¼šä½¿ç”¨æˆ‘çš„ä½ç½®ï¼ˆæŒ‰äº†æ‰å®šä½ï¼‰ ----
document.getElementById('useHere').addEventListener('click', ()=>{
  const info = document.getElementById('wxInfo');
  if(!navigator.onLine){ info.textContent='ç›®å‰é›¢ç·šï¼Œç„¡æ³•æŸ¥è©¢å¤©æ°£'; return; }
  if(!navigator.geolocation){ info.textContent='ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½'; return; }
  info.textContent = 'å®šä½ä¸­â€¦è«‹åœ¨ç€è¦½å™¨å…è¨±å®šä½æ¬Šé™';
  navigator.geolocation.getCurrentPosition(async pos=>{
    try{
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      info.textContent = `å·²å–å¾—åº§æ¨™ï¼ˆ${lat.toFixed(4)}, ${lon.toFixed(4)}ï¼‰ï¼ŒæŸ¥è©¢å³æ™‚å¤©æ°£â€¦`;
      const wx = await fetchWeather(lat, lon);
      const m = mapWeatherToParams(wx);
      setVal('wAttn', m.attn.toFixed(2));
      setVal('skyT', Math.round(m.sky));
      info.textContent = `æˆ‘çš„ä½ç½® â†’ é™æ°´ ${m.pr} mm/hï¼Œé›²é‡ ${m.cc}%ï¼Œåœ°é¢æº«åº¦ ${m.temp}Â°C â†’ å»ºè­° Attn ${m.attn.toFixed(2)} dB / Sky ${Math.round(m.sky)} K`;
      computeAndDraw();
    }catch(err){
      info.textContent='å®šä½æˆåŠŸä½†æŸ¥å¤©æ°£å¤±æ•—ï¼š'+(err.message||err);
    }
  }, err=>{
    const code = err && err.code;
    if(code===1) info.textContent = 'ä½ æ‹’çµ•äº†å®šä½æ¬Šé™ï¼ˆå¯æ”¹æŒ‰ã€ŒæŸ¥åŸå¸‚å¤©æ°£ã€ï¼‰';
    else if(code===2) info.textContent = 'ç„¡æ³•å–å¾—ä½ç½®ï¼ˆå¯èƒ½ GPS é—œé–‰æˆ–ç¶²è·¯ä¸ç©©ï¼‰';
    else if(code===3) info.textContent = 'å®šä½é€¾æ™‚ï¼Œè«‹é‡è©¦';
    else info.textContent = 'å®šä½å¤±æ•—ï¼š'+err.message;
  }, {enableHighAccuracy:false, timeout:10000, maximumAge:300000});
});

// åˆå§‹åŒ–
renderNetStatus();
readParams();
bindAutoUpdate();
computeAndDraw();
updateShareUrl();
</script>
</body>
</html>
